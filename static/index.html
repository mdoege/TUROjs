<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>TUROjs</title>
<link rel="stylesheet" href="chessboard.css">
</head>
<body>
<script src="jquery-3.4.0.min.js"></script>
<script src="chessboard.js"></script>
<script src="chess.js"></script>
<script>
$(document).ready(function() {
	function talk(text) {
		var msg = new SpeechSynthesisUtterance(text);
		msg.lang = 'en-US';
		window.speechSynthesis.speak(msg);
	}
	talk("Hello, welcome to Too Row Champ!");
	talk("How about a nice game of chess?");

	var setfen = function(source, target, piece, newPos, oldPos, orientation) {
		var ret = chess.move(source + target, {sloppy: true});
		var fen = chess.fen();
		if (ret == null) {
			talk("Illegal move!");
			talk("Please make a valid move instead!");
			if (chess.turn() == 'w') {
				talk("It is White's turn.");
			} else {
				talk("It is Black's turn.");
			}
		} else {
			fentext.innerHTML = fen;
			console.log(fen);
			spgn.innerHTML = chess.pgn();
			getmove();
		}
	}

	var board1 = ChessBoard('board1', {
		draggable: true,
		dropOffBoard: 'trash',
		onDrop: setfen,
	});
	board1.start();

	var chess = new Chess();
	$('#moveBtn').on('click', getmove);

	function getmove() {
		var fen = chess.fen();
		$.ajax({
			url: '/ptcmove',
			type: 'POST',
			contentType: 'application/json',
			data: JSON.stringify({
				fen: fen,
			}),
			success: function(data) {
				recmove(data);
			},
		});
		return true;
	}

	function recmove(data) {
		var moves = chess.moves({ verbose: true });

		for (j = 0; j < moves.length; j++) {
			if (moves[j].from + moves[j].to == data) {
				var mymove = moves[j];
			}
		}
		console.log(mymove.from + '-' + mymove.to);
		chess.move(mymove);
		board1.move(mymove.from + '-' + mymove.to);

		var fen = chess.fen();
		fentext.innerHTML = fen;
		console.log(fen);
		spgn.innerHTML = chess.pgn();

		var pnames = {
			'p': 'pawn',
			'n': 'knight',
			'b': 'bishop',
			'r': 'rook',
			'q': 'queen',
			'k': 'king',
		};
		talk(pnames[mymove.piece] + ' from ' + mymove.from + ' to ' + mymove.to);
		if (chess.in_check()) {
			talk('Check!');
		}
		if (chess.in_checkmate()) {
			talk('Checkmate!');
		}
	}


});
</script>
<h1>TUROCHAMP in your browser</h1>
<div id="fentext">none</div>
<table><tr>
<td><div id="board1" style="width: 650px"></div></td>
<td><div id="spgn">none</div></td>
</tr></table>
<br>
<input type="button" id="moveBtn" value="Get TUROCHAMP move now">
</body>
</html>

